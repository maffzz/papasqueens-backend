org: maferlazon
service: papasqueens-platform

provider:
  name: aws
  runtime: python3.13
  region: us-east-1
  memorySize: 1024
  timeout: 30
  cfnRole: arn:aws:iam::039871617247:role/LabRole
  iam:
    role: arn:aws:iam::039871617247:role/LabRole
  logs:
    frameworkLambda: true
  environment:
    ORDER_SFN_NAME: papasqueens-order-workflow
    EVENT_BUS: papasqueens-event-bus
    ORDERS_TABLE: Orders
    KITCHEN_TABLE: Kitchen
    DELIVERY_TABLE: Delivery
    ANALYTICS_TABLE: Analytics
    STAFF_TABLE: Staff
    MENU_TABLE: MenuItems
    USERS_TABLE: papasqueens-users
    MENU_BUCKET: papasqueens-menu-images
    RECEIPTS_BUCKET: papasqueens-orders-receipts
    STAFF_BUCKET: papasqueens-staff-docs
    ANALYTICS_BUCKET: papasqueens-analytics-exports
    JWT_SECRET: ${env:JWT_SECRET, 'change-me'}

  iamRoleStatements:
    - Effect: Allow
      Action:
        - dynamodb:*
        - s3:*
        - events:PutEvents
        - states:StartExecution
        - logs:CreateLogGroup
        - logs:CreateLogStream
        - logs:PutLogEvents
        - logs:DescribeLogGroups
        - logs:DescribeLogStreams
        - cloudwatch:PutMetricData
        - cloudwatch:GetMetricStatistics
        - cloudwatch:ListMetrics
      Resource: "*"
  tracing:
    lambda: true
    apiGateway: true

resources:
  Resources:
    OrdersTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: Orders
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: tenant_id
            AttributeType: S
          - AttributeName: id_order
            AttributeType: S
          - AttributeName: id_customer
            AttributeType: S
        KeySchema:
          - AttributeName: tenant_id
            KeyType: HASH
          - AttributeName: id_order
            KeyType: RANGE
        GlobalSecondaryIndexes:
          - IndexName: CustomerIndex
            KeySchema:
              - AttributeName: id_customer
                KeyType: HASH
            Projection:
              ProjectionType: ALL

    KitchenTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: Kitchen
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: tenant_id
            AttributeType: S
          - AttributeName: order_id
            AttributeType: S
        KeySchema:
          - AttributeName: tenant_id
            KeyType: HASH
          - AttributeName: order_id
            KeyType: RANGE

    DeliveryTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: Delivery
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: tenant_id
            AttributeType: S
          - AttributeName: id_delivery
            AttributeType: S
          - AttributeName: id_order
            AttributeType: S
        KeySchema:
          - AttributeName: tenant_id
            KeyType: HASH
          - AttributeName: id_delivery
            KeyType: RANGE
        GlobalSecondaryIndexes:
          - IndexName: OrderIndex
            KeySchema:
              - AttributeName: id_order
                KeyType: HASH
            Projection:
              ProjectionType: ALL

    AnalyticsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: Analytics
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: tenant_id
            AttributeType: S
          - AttributeName: id_metric
            AttributeType: S
          - AttributeName: id_order
            AttributeType: S
        KeySchema:
          - AttributeName: tenant_id
            KeyType: HASH
          - AttributeName: id_metric
            KeyType: RANGE
        GlobalSecondaryIndexes:
          - IndexName: OrderIndex
            KeySchema:
              - AttributeName: id_order
                KeyType: HASH
            Projection:
              ProjectionType: ALL

    StaffTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: Staff
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: tenant_id
            AttributeType: S
          - AttributeName: id_staff
            AttributeType: S
        KeySchema:
          - AttributeName: tenant_id
            KeyType: HASH
          - AttributeName: id_staff
            KeyType: RANGE

    MenuItemsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: MenuItems
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: tenant_id
            AttributeType: S
          - AttributeName: id_producto
            AttributeType: S
        KeySchema:
          - AttributeName: tenant_id
            KeyType: HASH
          - AttributeName: id_producto
            KeyType: RANGE

    UsersTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: papasqueens-users
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: tenant_id
            AttributeType: S
          - AttributeName: email
            AttributeType: S
        KeySchema:
          - AttributeName: tenant_id
            KeyType: HASH
          - AttributeName: email
            KeyType: RANGE

    # S3 BUCKETS
    MenuImagesBucket:
      Type: AWS::S3::Bucket
      Properties:
        BucketName: papasqueens-menu-images

    OrdersReceiptsBucket:
      Type: AWS::S3::Bucket
      Properties:
        BucketName: papasqueens-orders-receipts

    StaffDocsBucket:
      Type: AWS::S3::Bucket
      Properties:
        BucketName: papasqueens-staff-docs

    AnalyticsExportsBucket:
      Type: AWS::S3::Bucket
      Properties:
        BucketName: papasqueens-analytics-exports

    # EVENTBRIDGE BUS

    # STEP FUNCTIONS STATE MACHINE
    OrderWorkflowStateMachine:
      Type: AWS::StepFunctions::StateMachine
      Properties:
        StateMachineName: papasqueens-order-workflow
        RoleArn: arn:aws:iam::039871617247:role/LabRole
        DefinitionString:
          Fn::Sub:
            - |
              {
                "Comment": "Flujo de pedidos Papas Queen's",
                "StartAt": "ValidateOrder",
                "States": {
                  "ValidateOrder": {
                    "Type": "Task",
                    "Resource": "arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:${ServiceName}-${Stage}-createOrder",
                    "Next": "SaveOrder"
                  },
                  "SaveOrder": {
                    "Type": "Task",
                    "Resource": "arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:${ServiceName}-${Stage}-createOrder",
                    "Next": "WaitForPrepared"
                  },
                  "WaitForPrepared": {
                    "Type": "Wait",
                    "Seconds": 60,
                    "Next": "AssignDelivery"
                  },
                  "AssignDelivery": {
                    "Type": "Task",
                    "Resource": "arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:${ServiceName}-${Stage}-assignDelivery",
                    "Next": "WaitForDelivered"
                  },
                  "WaitForDelivered": {
                    "Type": "Wait",
                    "Seconds": 60,
                    "Next": "UpdateAnalytics"
                  },
                  "UpdateAnalytics": {
                    "Type": "Task",
                    "Resource": "arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:${ServiceName}-${Stage}-collectDeliveryMetrics",
                    "Next": "CloseOrder"
                  },
                  "CloseOrder": {
                    "Type": "Task",
                    "Resource": "arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:${ServiceName}-${Stage}-handleOrderDelivered",
                    "End": true
                  }
                }
              }
            - ServiceName: ${self:service}
              Stage: ${self:provider.stage, 'dev'}

functions:
  ${file(./functions.yml)}