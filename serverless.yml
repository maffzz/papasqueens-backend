org: maferlazon
service: papasqueens-platform

custom:
  pythonRequirements:
    fileName: requirements.txt
    slim: true
    strip: true
    dockerizePip: true
  defaultLayers: &defaultLayers
    - Ref: SharedLambdaLayer

layers:
  shared:
    path: layers/shared
    name: ${self:service}-shared
    compatibleRuntimes:
      - python3.13

package:
  individually: true
  patterns:
    - '!**/.git/**'
    - '!**/__pycache__/**'
    - '!**/*.pyc'
    - '!node_modules/**'
    - requirements.txt

provider:
  name: aws
  runtime: python3.13
  region: us-east-1
  memorySize: 1024
  timeout: 29
  iam:
    role: arn:aws:iam::850561899873:role/LabRole
  logs:
    frameworkLambda: true
  environment:
    EVENT_BUS: papasqueens-event-bus-${sls:stage}
    ORDERS_TABLE: Orders
    KITCHEN_TABLE: Kitchen
    DELIVERY_TABLE: Delivery
    ANALYTICS_TABLE: Analytics
    STAFF_TABLE: Staff
    MENU_TABLE: MenuItems
    PRODUCTS_TABLE: Products
    SUCURSAL_TABLE: Sucursals
    USERS_TABLE: papasqueens-users
    MENU_BUCKET: papasqueens-menu-images
    PROOF_BUCKET: papasqueens-delivery-proof
    RECEIPTS_BUCKET: papasqueens-orders-receipts
    STAFF_BUCKET: papasqueens-staff-docs
    ANALYTICS_BUCKET: papasqueens-analytics-exports
    AUTH_SECRET: ${env:AUTH_SECRET, "change-me-dev-secret"}

  iamRoleStatements:
    - Effect: Allow
      Action:
        - dynamodb:*
        - s3:*
        - events:PutEvents
        - states:StartExecution
        - logs:CreateLogGroup
        - logs:CreateLogStream
        - logs:PutLogEvents
        - logs:DescribeLogGroups
        - logs:DescribeLogStreams
        - cloudwatch:PutMetricData
        - cloudwatch:GetMetricStatistics
        - cloudwatch:ListMetrics
      Resource: "*"
  tracing:
    lambda: true
    apiGateway: true

resources:
  Resources:
    OrdersTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: Orders
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: id_order
            AttributeType: S
          - AttributeName: id_customer
            AttributeType: S
          - AttributeName: tenant_id
            AttributeType: S
        KeySchema:
          - AttributeName: id_order
            KeyType: HASH
        GlobalSecondaryIndexes:
          - IndexName: GSI1
            KeySchema:
              - AttributeName: id_customer
                KeyType: HASH
            Projection:
              ProjectionType: ALL
          - IndexName: TenantIndex
            KeySchema:
              - AttributeName: tenant_id
                KeyType: HASH
            Projection:
              ProjectionType: ALL

    KitchenTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: Kitchen
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: order_id
            AttributeType: S
          - AttributeName: tenant_id
            AttributeType: S
        KeySchema:
          - AttributeName: order_id
            KeyType: HASH
        GlobalSecondaryIndexes:
          - IndexName: TenantIndex
            KeySchema:
              - AttributeName: tenant_id
                KeyType: HASH
            Projection:
              ProjectionType: ALL

    DeliveryTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: Delivery
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: id_delivery
            AttributeType: S
          - AttributeName: id_order
            AttributeType: S
          - AttributeName: tenant_id
            AttributeType: S
        KeySchema:
          - AttributeName: id_delivery
            KeyType: HASH
        GlobalSecondaryIndexes:
          - IndexName: OrderIndex
            KeySchema:
              - AttributeName: id_order
                KeyType: HASH
            Projection:
              ProjectionType: ALL
          - IndexName: TenantIndex
            KeySchema:
              - AttributeName: tenant_id
                KeyType: HASH
            Projection:
              ProjectionType: ALL

    AnalyticsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: Analytics
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: id_metric
            AttributeType: S
          - AttributeName: tenant_id
            AttributeType: S
          - AttributeName: id_order
            AttributeType: S
        KeySchema:
          - AttributeName: id_metric
            KeyType: HASH
        GlobalSecondaryIndexes:
          - IndexName: TenantIndex
            KeySchema:
              - AttributeName: tenant_id
                KeyType: HASH
            Projection:
              ProjectionType: ALL
          - IndexName: OrderIndex
            KeySchema:
              - AttributeName: id_order
                KeyType: HASH
            Projection:
              ProjectionType: ALL

    StaffTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: Staff
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: id_staff
            AttributeType: S
          - AttributeName: tenant_id
            AttributeType: S
        KeySchema:
          - AttributeName: id_staff
            KeyType: HASH
        GlobalSecondaryIndexes:
          - IndexName: TenantIndex
            KeySchema:
              - AttributeName: tenant_id
                KeyType: HASH
            Projection:
              ProjectionType: ALL

    MenuItemsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: MenuItems
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: id_producto
            AttributeType: S
          - AttributeName: tenant_id
            AttributeType: S
        KeySchema:
          - AttributeName: id_producto
            KeyType: HASH
        GlobalSecondaryIndexes:
          - IndexName: TenantIndex
            KeySchema:
              - AttributeName: tenant_id
                KeyType: HASH
            Projection:
              ProjectionType: ALL

    ProductsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: Products
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: id_producto
            AttributeType: S
        KeySchema:
          - AttributeName: id_producto
            KeyType: HASH
    
    UsersTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: papasqueens-users
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: email
            AttributeType: S
        KeySchema:
          - AttributeName: email
            KeyType: HASH

    # S3 BUCKETS
    MenuImagesBucket:
      Type: AWS::S3::Bucket
      Properties:
        BucketName: papasqueens-menu-images

    DeliveryProofBucket:
      Type: AWS::S3::Bucket
      Properties:
        BucketName: papasqueens-delivery-proof

    OrdersReceiptsBucket:
      Type: AWS::S3::Bucket
      Properties:
        BucketName: papasqueens-orders-receipts

    StaffDocsBucket:
      Type: AWS::S3::Bucket
      Properties:
        BucketName: papasqueens-staff-docs

    AnalyticsExportsBucket:
      Type: AWS::S3::Bucket
      Properties:
        BucketName: papasqueens-analytics-exports

    SucursalTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: Sucursals
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: id_sucursal
            AttributeType: S
        KeySchema:
          - AttributeName: id_sucursal
            KeyType: HASH

    # EVENTBRIDGE BUS managed outside of this stack; using provider.environment.EVENT_BUS

    # STEP FUNCTIONS STATE MACHINE
    OrderWorkflowStateMachine:
      Type: AWS::StepFunctions::StateMachine
      Properties:
        StateMachineName: papasqueens-order-workflow
        RoleArn: arn:aws:iam::${aws:accountId}:role/LabRole
        DefinitionString:
          Fn::Sub:
            - |
              {
                "Comment": "Flujo de pedidos Papas Queen's",
                "StartAt": "ValidateOrder",
                "States": {
                  "ValidateOrder": {
                    "Type": "Task",
                    "Resource": "arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:${ServiceName}-${Stage}-createOrder",
                    "Next": "SaveOrder"
                  },
                  "SaveOrder": {
                    "Type": "Task",
                    "Resource": "arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:${ServiceName}-${Stage}-createOrder",
                    "Next": "WaitForPrepared"
                  },
                  "WaitForPrepared": {
                    "Type": "Wait",
                    "Seconds": 60,
                    "Next": "AssignDelivery"
                  },
                  "AssignDelivery": {
                    "Type": "Task",
                    "Resource": "arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:${ServiceName}-${Stage}-assignDelivery",
                    "Next": "WaitForDelivered"
                  },
                  "WaitForDelivered": {
                    "Type": "Wait",
                    "Seconds": 60,
                    "Next": "UpdateAnalytics"
                  },
                  "UpdateAnalytics": {
                    "Type": "Task",
                    "Resource": "arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:${ServiceName}-${Stage}-collectDeliveryMetrics",
                    "Next": "CloseOrder"
                  },
                  "CloseOrder": {
                    "Type": "Task",
                    "Resource": "arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:${ServiceName}-${Stage}-handleOrderDelivered",
                    "End": true
                  }
                }
              }
            - ServiceName: ${self:service}
              Stage: ${self:provider.stage, 'dev'}

functions:

  jwtAuthorizer:
    handler: auth/authorizer.handler
    layers: *defaultLayers

  # ORDERS-SVC
  createOrder:
    handler: orders-svc/create_order.handler
    events:
      - http:
          path: orders
          method: post
          cors: true
          authorizer: jwtAuthorizer
    layers: *defaultLayers
  getOrder:
    handler: orders-svc/get_order.handler
    events:
      - http:
          path: orders/{id_order}
          method: get
          cors: true
          authorizer: jwtAuthorizer
    memorySize: 512
    timeout: 15
    layers: *defaultLayers
  getOrderStatus:
    handler: orders-svc/get_order_status.handler
    events:
      - http:
          path: orders/{id_order}/status
          method: get
          cors: true
          authorizer: jwtAuthorizer
    memorySize: 512
    timeout: 15
    layers: *defaultLayers
  getCustomerOrders:
    handler: orders-svc/get_customer_orders.handler
    events:
      - http:
          path: orders/customer/{id_customer}
          method: get
          cors: true
          authorizer: jwtAuthorizer
    memorySize: 512
    timeout: 15
    layers: *defaultLayers
  cancelOrder:
    handler: orders-svc/cancel_order.handler
    events:
      - http:
          path: orders/{id_order}/cancel
          method: post
          cors: true
          authorizer: jwtAuthorizer
    memorySize: 512
    timeout: 15
    layers: *defaultLayers
  handleOrderDelivered:
    handler: orders-svc/handle_order_delivered.handler
    events:
      - eventBridge:
          eventBus: ${self:provider.environment.EVENT_BUS}
          pattern:
            detail-type: ["Order.Delivered"]
    layers: *defaultLayers
  listProducts:
    handler: orders-svc/list_products.handler
    events:
      - http:
          path: menu
          method: get
          cors: true
          authorizer: jwtAuthorizer
    layers: *defaultLayers
  getProductsByCategory:
    handler: orders-svc/get_products_by_category.handler
    events:
      - http:
          path: menu/category/{categoria}
          method: get
          cors: true
          authorizer: jwtAuthorizer
    layers: *defaultLayers

  # KITCHEN-SVC
  receiveOrder:
    handler: kitchen-svc/receive_order.handler
    events:
      - eventBridge:
          eventBus: ${self:provider.environment.EVENT_BUS}
          pattern:
            detail-type: ["Order.Created"]
    layers: *defaultLayers
  getKitchenQueue:
    handler: kitchen-svc/get_kitchen_queue.handler
    events:
      - http:
          path: kitchen/queue
          method: get
          cors: true
          authorizer: jwtAuthorizer
    memorySize: 512
    timeout: 15
    layers: *defaultLayers
  acceptOrder:
    handler: kitchen-svc/accept_order.handler
    events:
      - http:
          path: kitchen/orders/{order_id}/accept
          method: post
          cors: true
          authorizer: jwtAuthorizer
    layers: *defaultLayers
  packOrder:
    handler: kitchen-svc/pack_order.handler
    events:
      - http:
          path: kitchen/orders/{order_id}/pack
          method: post
          cors: true
          authorizer: jwtAuthorizer
    layers: *defaultLayers
  listMenuItems:
    handler: kitchen-svc/list_menu_items.handler
    events:
      - http:
          path: kitchen/menu
          method: get
          cors: true
          authorizer: jwtAuthorizer
    memorySize: 512
    timeout: 15
    layers: *defaultLayers
  addMenuItem:
    handler: kitchen-svc/add_menu_item.handler
    events:
      - http:
          path: menu
          method: post
          cors: true
          authorizer: jwtAuthorizer
    layers: *defaultLayers
  updateMenuItem:
    handler: kitchen-svc/update_menu_item.handler
    events:
      - http:
          path: menu/{id_producto}
          method: patch
          cors: true
          authorizer: jwtAuthorizer
    layers: *defaultLayers
  deleteMenuItem:
    handler: kitchen-svc/delete_menu_item.handler
    events:
      - http:
          path: menu/{id_producto}
          method: delete
          cors: true
          authorizer: jwtAuthorizer
    memorySize: 512
    timeout: 15
    layers: *defaultLayers
  manageStaff:
    handler: kitchen-svc/manage_staff.handler
    events:
      - http:
          path: staff
          method: post
          cors: true
          authorizer: jwtAuthorizer
      - http:
          path: staff/{id_staff}
          method: patch
          cors: true
          authorizer: jwtAuthorizer
    memorySize: 1536
    timeout: 29
    layers: *defaultLayers
  listStaff:
    handler: kitchen-svc/list_staff.handler
    events:
      - http:
          path: staff
          method: get
          cors: true
          authorizer: jwtAuthorizer
    layers: *defaultLayers

  # DELIVERY-SVC
  receivePreparedOrder:
    handler: delivery-svc/receive_prepared_order.handler
    events:
      - eventBridge:
          eventBus: ${self:provider.environment.EVENT_BUS}
          pattern:
            detail-type: ["Order.Prepared"]
    layers: *defaultLayers
  assignDelivery:
    handler: delivery-svc/assign_delivery.handler
    events:
      - http:
          path: delivery/assign
          method: post
          cors: true
          authorizer: jwtAuthorizer
    layers: *defaultLayers
  updateDeliveryStatus:
    handler: delivery-svc/update_delivery_status.handler
    events:
      - http:
          path: delivery/{id_delivery}/status
          method: patch
          cors: true
          authorizer: jwtAuthorizer
    memorySize: 512
    timeout: 15
    layers: *defaultLayers
  confirmDelivered:
    handler: delivery-svc/confirm_delivered.handler
    events:
      - http:
          path: delivery/{id_delivery}/delivered
          method: post
          cors: true
          authorizer: jwtAuthorizer
    layers: *defaultLayers
  getDeliveryStatus:
    handler: delivery-svc/get_delivery_status.handler
    events:
      - http:
          path: delivery/{id_delivery}
          method: get
          cors: true
          authorizer: jwtAuthorizer
    memorySize: 512
    timeout: 15
    layers: *defaultLayers
  listRiders:
    handler: delivery-svc/list_riders.handler
    events:
      - http:
          path: riders
          method: get
          cors: true
          authorizer: jwtAuthorizer
    memorySize: 512
    timeout: 15
    layers: *defaultLayers
  updateRiderStatus:
    handler: delivery-svc/update_rider_status.handler
    events:
      - http:
          path: riders/{id_staff}/status
          method: patch
          cors: true
          authorizer: jwtAuthorizer
    memorySize: 512
    timeout: 15
    layers: *defaultLayers
  updateRiderLocation:
    handler: delivery-svc/update_rider_location.handler
    events:
      - http:
          path: delivery/location
          method: post
          cors: true
          authorizer: jwtAuthorizer
    memorySize: 512
    timeout: 15
    layers: *defaultLayers
  

  # ANALYTICS-SVC
  collectOrderMetrics:
    handler: analytics-svc/collect_order_metrics.handler
    events:
      - eventBridge:
          eventBus: ${self:provider.environment.EVENT_BUS}
          pattern:
            detail-type: ["Order.Created"]
    layers: *defaultLayers
  collectKitchenMetrics:
    handler: analytics-svc/collect_kitchen_metrics.handler
    events:
      - eventBridge:
          eventBus: ${self:provider.environment.EVENT_BUS}
          pattern:
            detail-type: ["Order.Prepared"]
    layers: *defaultLayers
  collectDeliveryMetrics:
    handler: analytics-svc/collect_delivery_metrics.handler
    events:
      - eventBridge:
          eventBus: ${self:provider.environment.EVENT_BUS}
          pattern:
            detail-type: ["Order.Delivered"]
    layers: *defaultLayers
  collectStaffMetrics:
    handler: analytics-svc/collect_staff_metrics.handler
    events:
      - eventBridge:
          eventBus: ${self:provider.environment.EVENT_BUS}
          pattern:
            detail-type: 
              - "Staff.Updated"
              - "Kitchen.MetricsUpdated"
    layers: *defaultLayers
  orderAssignedConsumer:
    handler: analytics-svc/order_assigned_consumer.handler
    events:
      - eventBridge:
          eventBus: ${self:provider.environment.EVENT_BUS}
          pattern:
            detail-type: ["Order.Assigned"]
    layers: *defaultLayers
  orderCancelledConsumer:
    handler: analytics-svc/order_cancelled_consumer.handler
    events:
      - eventBridge:
          eventBus: ${self:provider.environment.EVENT_BUS}
          pattern:
            detail-type: ["Order.Cancelled"]
    layers: *defaultLayers
  getAnalyticsOrders:
    handler: analytics-svc/get_analytics_orders.handler
    events:
      - http:
          path: analytics/orders
          method: get
          cors: true
          authorizer: jwtAuthorizer
    layers: *defaultLayers
  getAnalyticsEmployees:
    handler: analytics-svc/get_analytics_employees.handler
    events:
      - http:
          path: analytics/employees
          method: get
          cors: true
          authorizer: jwtAuthorizer
    layers: *defaultLayers
  getAnalyticsDelivery:
    handler: analytics-svc/get_analytics_delivery.handler
    events:
      - http:
          path: analytics/delivery
          method: get
          cors: true
          authorizer: jwtAuthorizer
    layers: *defaultLayers
  getDashboard:
    handler: analytics-svc/get_dashboard.handler
    events:
      - http:
          path: analytics/dashboard
          method: get
          cors: true
          authorizer: jwtAuthorizer
    layers: *defaultLayers
  exportAnalyticsReport:
    handler: analytics-svc/export_analytics_report.handler
    events:
      - schedule: rate(1 day)
    memorySize: 2048
    timeout: 120
    layers: *defaultLayers

  # LOGIN
  userLogin:
    handler: orders-svc/login.handler
    events:
      - http:
          path: login
          method: post
          cors: true
    environment:
      USERS_TABLE: ${self:provider.environment.USERS_TABLE}
    layers: *defaultLayers
  registerUser:
    handler: orders-svc/register.handler
    events:
      - http:
          path: register
          method: post
          cors: true
    environment:
      USERS_TABLE: ${self:provider.environment.USERS_TABLE}
    timeout: 29
    layers: *defaultLayers